<svg width="1200" height="600" viewBox="0 0 1200 600" xmlns="http://www.w3.org/2000/svg" style="background-color: transparent;">
  <style>
    /* Global Fonts */
    .font-latex { font-family: 'Times New Roman', serif; }
    .font-rf { font-family: 'Helvetica', 'Arial', sans-serif; }

    /* Latex Style (Neural) */
    .latex-box { fill: #ffffff; stroke: #000000; stroke-width: 2; shape-rendering: crispEdges; }
    .latex-grid { stroke: #cccccc; stroke-width: 1; }
    .latex-text { font-family: 'Times New Roman', serif; font-size: 14px; fill: #000000; text-anchor: middle; font-style: italic; }
    .latex-title { font-family: 'Times New Roman', serif; font-size: 16px; fill: #000000; text-anchor: middle; font-weight: bold; }
    .latex-edge { stroke: #000000; stroke-width: 1.5; fill: none; marker-end: url(#arrow); }
    .latex-edge-dashed { stroke: #000000; stroke-width: 1.5; fill: none; stroke-dasharray: 6,4; marker-end: url(#arrow); }

    /* ReactFlow Style (Symbolic) */
    .rf-node { fill: #ffffff; stroke: #555555; stroke-width: 2; rx: 10; ry: 10; filter: drop-shadow(0px 4px 6px rgba(0,0,0,0.15)); }
    .rf-handle { fill: #ffffff; stroke: #555555; stroke-width: 2; }
    .rf-edge { stroke: #666666; stroke-width: 2; fill: none; }
    .rf-text { font-family: 'Helvetica', 'Arial', sans-serif; font-size: 13px; fill: #333333; text-anchor: middle; font-weight: 500; }
    .rf-text-gray { font-family: 'Helvetica', 'Arial', sans-serif; font-size: 13px; fill: #777777; text-anchor: middle; font-weight: 400; }

    /* Animations */
    .pulse-neural { fill: #000000; }
    .pulse-token { fill: #333333; stroke: white; stroke-width: 1; }

    @keyframes flow {
      0% { offset-distance: 0%; opacity: 0; }
      10% { opacity: 1; }
      90% { opacity: 1; }
      100% { offset-distance: 100%; opacity: 0; }
    }
    
    .anim-fast { animation: flow 1.5s linear infinite; }
    .anim-med { animation: flow 2.5s linear infinite; }
    .anim-slow { animation: flow 4s linear infinite; }
  </style>

  <defs>
    <marker id="arrow" markerWidth="10" markerHeight="10" refX="9" refY="3" orient="auto" markerUnits="strokeWidth">
      <path d="M0,0 L0,6 L9,3 z" fill="#000" />
    </marker>
  </defs>

  <!-- ================= LEFT: NEURAL CONTROLLER (Latex) ================= -->
  
  <g transform="translate(50, 100)">
    <!-- Encoders Stack -->
    <!-- Enc 1 -->
    <rect x="0" y="0" width="60" height="40" class="latex-box" />
    <path d="M 0 20 L 60 20 M 30 0 L 30 40" class="latex-grid" />
    <text x="30" y="-8" class="latex-text">Enc_{txt}</text>

    <!-- Enc 2 -->
    <rect x="0" y="70" width="60" height="40" class="latex-box" />
    <path d="M 0 90 L 60 90 M 30 70 L 30 110" class="latex-grid" />
    <text x="30" y="62" class="latex-text">Enc_{img}</text>

    <!-- Enc 3 -->
    <rect x="0" y="140" width="60" height="40" class="latex-box" />
    <path d="M 0 160 L 60 160 M 30 140 L 30 180" class="latex-grid" />
    <text x="30" y="132" class="latex-text">Enc_{aud}</text>

    <!-- Enc 4 (Empty/Generic) -->
    <rect x="0" y="210" width="60" height="40" class="latex-box" />
    <path d="M 0 230 L 60 230 M 30 210 L 30 250" class="latex-grid" />
  </g>

  <!-- Aggregation (Circle +) -->
  <g transform="translate(170, 155)">
    <circle cx="0" cy="0" r="25" class="latex-box" />
    <text x="0" y="6" class="latex-title" style="font-size: 24px;">+</text>
    <text x="0" y="45" class="latex-text">Concat</text>
  </g>

  <!-- Inputs -> Aggregator (Curved) -->
  <path d="M 110 20 C 130 20, 130 135, 148 142" class="latex-edge" marker-end="url(#arrow)" />
  <path d="M 110 90 C 125 90, 125 150, 145 155" class="latex-edge" marker-end="url(#arrow)" />
  <path d="M 110 160 C 125 160, 125 165, 148 165" class="latex-edge" marker-end="url(#arrow)" />
  <path d="M 110 230 C 130 230, 130 180, 150 175" class="latex-edge" marker-end="url(#arrow)" />

  <!-- LLM Stack -->
  <g transform="translate(290, 100)">
    <text x="60" y="-10" class="latex-title">LLM_\theta</text>
    <!-- Layers -->
    <rect x="0" y="0" width="120" height="30" class="latex-box" />
    <text x="60" y="20" class="latex-text">L_N</text>
    
    <rect x="0" y="30" width="120" height="30" class="latex-box" />
    <text x="60" y="50" class="latex-text">...</text>

    <rect x="0" y="60" width="120" height="30" class="latex-box" />
    <text x="60" y="80" class="latex-text">L_2</text>
    
    <rect x="0" y="90" width="120" height="30" class="latex-box" />
    <text x="60" y="110" class="latex-text">L_1</text>
  </g>

  <!-- Aggregator -> LLM (Curved) -->
  <path d="M 195 155 C 220 155, 260 155, 290 155" class="latex-edge" id="edge_agg_llm" />
  <circle r="3" class="pulse-neural">
    <animateMotion dur="2s" repeatCount="indefinite">
      <mpath href="#edge_agg_llm"/>
    </animateMotion>
  </circle>


  <!-- ================= RIGHT: EXECUTION GRAPH (ReactFlow) ================= -->
  
  <!-- Dashed Connection LLM -> Orchestrator (Curved) -->
  <path d="M 410 155 C 430 155, 460 155, 480 155" class="latex-edge-dashed" />

  <!-- Orchestrator Node -->
  <g transform="translate(490, 115)">
    <rect x="0" y="0" width="140" height="80" class="rf-node" />
    <circle cx="0" cy="40" r="5" class="rf-handle" />
    <circle cx="140" cy="40" r="5" class="rf-handle" />
    <text x="70" y="45" class="rf-text" style="font-weight: bold;">Context Orchestrator</text>
  </g>

  <!-- Branch Nodes -->
  
  <!-- Top: Search Tool -->
  <g transform="translate(740, 50)">
    <rect x="0" y="0" width="100" height="50" class="rf-node" />
    <circle cx="0" cy="25" r="5" class="rf-handle" />
    <circle cx="100" cy="25" r="5" class="rf-handle" />
    <text x="50" y="30" class="rf-text">Search Tool</text>
  </g>
  
  <!-- Leaf: Result -->
  <g transform="translate(940, 50)">
    <rect x="0" y="0" width="80" height="40" class="rf-node" style="stroke: #777;" />
    <circle cx="0" cy="20" r="5" class="rf-handle" />
    <text x="40" y="25" class="rf-text-gray">Result</text>
  </g>

  <!-- Mid: Code Sandbox -->
  <g transform="translate(740, 150)">
    <rect x="0" y="0" width="100" height="50" class="rf-node" />
    <circle cx="0" cy="25" r="5" class="rf-handle" />
    <circle cx="100" cy="25" r="5" class="rf-handle" />
    <text x="50" y="30" class="rf-text">Code Sandbox</text>
  </g>

  <!-- Leaf: Output -->
  <g transform="translate(940, 180)">
    <rect x="0" y="0" width="80" height="40" class="rf-node" style="stroke: #777;" />
    <circle cx="0" cy="20" r="5" class="rf-handle" />
    <text x="40" y="25" class="rf-text-gray">Output</text>
  </g>

  <!-- Bot: Vector Map -->
  <g transform="translate(740, 250)">
    <rect x="0" y="0" width="100" height="50" class="rf-node" />
    <circle cx="0" cy="25" r="5" class="rf-handle" />
    <circle cx="100" cy="25" r="5" class="rf-handle" />
    <text x="50" y="30" class="rf-text">Vector Map</text>
  </g>


  <!-- ReactFlow Edges (Curved) -->
  <!-- Orch -> Search -->
  <path d="M 630 155 C 680 155, 680 75, 740 75" class="rf-edge" id="edge_search" />
  <!-- Orch -> Code -->
  <path d="M 630 155 C 680 155, 680 175, 740 175" class="rf-edge" id="edge_code" />
  <!-- Orch -> Map -->
  <path d="M 630 155 C 680 155, 680 275, 740 275" class="rf-edge" id="edge_map" />
  
  <!-- Search -> Result -->
  <path d="M 840 75 C 890 75, 890 70, 940 70" class="rf-edge" id="edge_res" />
  <!-- Code -> Output -->
  <path d="M 840 175 C 890 175, 890 200, 940 200" class="rf-edge" id="edge_out" />

  <!-- Graph Animations -->
  <circle r="4" class="pulse-token">
    <animateMotion class="anim-med">
      <mpath href="#edge_search"/>
    </animateMotion>
  </circle>
  <circle r="4" class="pulse-token">
    <animateMotion class="anim-med" begin="0.8s">
      <mpath href="#edge_code"/>
    </animateMotion>
  </circle>
  <circle r="4" class="pulse-token">
    <animateMotion class="anim-slow" begin="1.2s">
      <mpath href="#edge_map"/>
    </animateMotion>
  </circle>
  <circle r="4" class="pulse-token">
    <animateMotion class="anim-fast" begin="2.5s">
      <mpath href="#edge_res"/>
    </animateMotion>
  </circle>
   <circle r="4" class="pulse-token">
    <animateMotion class="anim-fast" begin="3.3s">
      <mpath href="#edge_out"/>
    </animateMotion>
  </circle>

</svg>
